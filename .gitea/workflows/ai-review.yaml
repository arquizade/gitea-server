name: Local AI Code Review
on:
  pull_request:
    types: [opened, synchronized]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Git Authentication
        run: |
          # Configure git to use HTTP credentials
          git config --global credential.helper store
          echo "http://git:${{ secrets.GITEA_TOKEN }}@172.20.0.2:3000" >> ~/.git-credentials
          chmod 600 ~/.git-credentials
          # Add hosts to /etc/hosts for hostname resolution
          echo "172.20.0.2 gitea" | sudo tee -a /etc/hosts
          echo "172.20.0.3 ollama" | sudo tee -a /etc/hosts

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITEA_TOKEN }}
          fetch-depth: 0

      - name: Get Diff and Review
        run: |
          # 1. Capture the changes in the PR
          git diff HEAD^ HEAD > pr_diff.txt
          
          # 2. Create proper JSON file to avoid escaping issues
          DIFF_CONTENT=$(cat pr_diff.txt | jq -sRr .)
          cat > /tmp/ollama_request.json <<EOF
          {
            "model": "llama3",
            "stream": false,
            "prompt": "Review this git diff for bugs and security issues. Be concise:\n\n${DIFF_CONTENT}"
          }
          EOF
          
          echo "ðŸ“¤ Sending to Ollama at 172.20.0.3:11434..."
          
          # 3. Call Ollama with file-based JSON (cleaner, no escaping issues)
          RAW_RESPONSE=$(curl -i -X POST http://172.20.0.3:11434/api/generate \
            --connect-timeout 10 \
            --max-time 60 \
            -H "Content-Type: application/json" \
            -d @/tmp/ollama_request.json)
          
          echo -e "\nðŸ“¥ RAW API RESPONSE:\n$RAW_RESPONSE\n"
          
          # 4. Extract just the response body (skip headers)
          RESPONSE=$(echo "$RAW_RESPONSE" | tail -1 | jq -r '.response // "ERROR: Could not parse response"')
          
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "null" ] || [[ "$RESPONSE" == *"ERROR"* ]]; then
            echo "âŒ Warning: Could not get valid response from Ollama"
            RESPONSE="AI review service unavailable. Please review the code manually."
          fi

          echo "âœ… AI Review Response: $RESPONSE"
          echo "REVIEW_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post AI Review as Comment
        if: always()
        run: |
          # Post the review as a comment on the PR
          REVIEW_TEXT="${{ env.REVIEW_RESPONSE }}"
          OWNER="${{ gitea.repository_owner }}"
          REPO="${{ gitea.repository_name }}"
          PR_NUMBER="${{ gitea.event.pull_request.number }}"
          TOKEN="${{ secrets.GITEA_TOKEN }}"
          
          echo "Posting comment to: /repos/$OWNER/$REPO/issues/$PR_NUMBER/comments"
          
          # Create JSON payload file to avoid escaping issues
          REVIEW_CONTENT=$(echo "$REVIEW_TEXT" | jq -sRr .)
          cat > /tmp/comment_request.json <<EOF
          {
            "body": "### ðŸ¤– Local AI Code Review\n\n${REVIEW_CONTENT}"
          }
          EOF
          
          echo "ðŸ“‹ Comment payload:"
          cat /tmp/comment_request.json
          
          curl -v -X POST "http://172.20.0.2:3000/api/v1/repos/$OWNER/$REPO/issues/$PR_NUMBER/comments" \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/comment_request.json \
            --connect-timeout 10 \
            --max-time 30