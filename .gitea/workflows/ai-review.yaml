name: Local AI Code Review
on:
  pull_request:
    types: [opened, synchronized]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Git
        run: |
          git config --global credential.helper store
          # Using the new secret name here
          echo "http://git:${{ secrets.AI_REVIEW_TOKEN }}@172.20.0.2:3000" >> ~/.git-credentials
          chmod 600 ~/.git-credentials
          echo "172.20.0.2 gitea" | sudo tee -a /etc/hosts
          echo "172.20.0.3 ollama" | sudo tee -a /etc/hosts

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AI_REVIEW_TOKEN }}
          fetch-depth: 0

      - name: Ensure Model Exists
        run: |
          echo "Checking for qwen2.5-coder:3b..."
          curl -s -X POST http://172.20.0.3:11434/api/pull -d '{"name": "qwen2.5-coder:3b"}'

      - name: Get Diff and Review
        run: |
          git diff HEAD^ HEAD > pr_diff.txt
          
          # Build JSON safely with jq
          jq -n \
            --arg model "qwen2.5-coder:3b" \
            --arg diff "$(cat pr_diff.txt)" \
            '{
              model: $model, 
              stream: false, 
              prompt: ("Review this git diff for bugs and security issues. Be very concise and use bullet points:\n\n" + $diff),
              options: { num_predict: 300, temperature: 0.2 }
            }' > /tmp/ollama_request.json
          
          # Call Ollama
          RESPONSE_JSON=$(curl -sS -X POST http://172.20.0.3:11434/api/generate \
            -H "Content-Type: application/json" \
            -d @/tmp/ollama_request.json)
          
          # Extract response
          RESPONSE=$(echo "$RESPONSE_JSON" | jq -r '.response // empty')
          
          if [ -z "$RESPONSE" ]; then
            RESPONSE="AI review service unavailable. Please review manually."
          fi

          echo "REVIEW_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post Comment
        if: always()
        run: |
          # Build comment JSON
          jq -n --arg body "### ðŸ¤– Local AI Code Review
          ${{ env.REVIEW_RESPONSE }}" '{body: $body}' > /tmp/comment.json

          # Post to Gitea using the updated secret name
          curl -sS -X POST "http://172.20.0.2:3000/api/v1/repos/${{ gitea.repository }}/issues/${{ gitea.event.pull_request.number }}/comments" \
            -H "Authorization: token ${{ secrets.AI_REVIEW_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @/tmp/comment.json