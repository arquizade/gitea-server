name: Local AI Code Review
on:
  pull_request:
    types: [opened, synchronized]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Git Authentication
        run: |
          # Configure git to use HTTP credentials
          git config --global credential.helper store
          echo "http://git:${{ secrets.GITEA_TOKEN }}@172.20.0.2:3000" >> ~/.git-credentials
          chmod 600 ~/.git-credentials
          # Add hosts to /etc/hosts for hostname resolution
          echo "172.20.0.2 gitea" | sudo tee -a /etc/hosts
          echo "172.20.0.3 ollama" | sudo tee -a /etc/hosts

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITEA_TOKEN }}
          fetch-depth: 0

      - name: Get Diff and Review
        run: |
          # 1. Capture the changes in the PR
          git diff HEAD^ HEAD > pr_diff.txt
          
          # Debug: Check if diff is empty
          if [ ! -s pr_diff.txt ]; then
            echo "âš ï¸  WARNING: pr_diff.txt is empty!"
            echo "Available branches:"
            git branch -a
            echo "Git log:"
            git log --oneline -5
            echo "Trying alternative diff..."
            git diff HEAD > pr_diff.txt
          fi
          
          echo "ðŸ“‹ Diff file size: $(wc -c < pr_diff.txt) bytes"
          echo "First 500 chars of diff:"
          head -c 500 pr_diff.txt
          echo -e "\n---"
          
          # 2. Prepare the content for Ollama
          DIFF_CONTENT=$(cat pr_diff.txt | jq -sRr @json)
          echo "ðŸ“¤ Sending to Ollama at 172.20.0.3:11434..."
          
          # 3. Call Ollama with full error output (not silent)
          RAW_RESPONSE=$(curl -i -X POST http://172.20.0.3:11434/api/generate \
            --connect-timeout 10 \
            --max-time 60 \
            -H "Content-Type: application/json" \
            -d "{\"model\": \"llama3\", \"prompt\": \"Review this git diff for bugs and security issues. Be concise:\\n\\n${DIFF_CONTENT}\", \"stream\": false}")
          
          echo -e "\nðŸ“¥ RAW API RESPONSE:\n$RAW_RESPONSE\n"
          
          # 4. Extract just the response body (skip headers)
          RESPONSE=$(echo "$RAW_RESPONSE" | tail -1 | jq -r '.response // "ERROR: Could not parse response"')
          
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "null" ] || [[ "$RESPONSE" == *"ERROR"* ]]; then
            echo "âŒ Warning: Could not get valid response from Ollama"
            RESPONSE="AI review service unavailable. Please review the code manually."
          fi

          echo "âœ… AI Review Response: $RESPONSE"
          echo "REVIEW_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post AI Review as Comment
        if: always()
        run: |
          # Post the review as a comment on the PR
          REVIEW_TEXT="${{ env.REVIEW_RESPONSE }}"
          OWNER="${{ gitea.repository_owner }}"
          REPO="${{ gitea.repository_name }}"
          PR_NUMBER="${{ gitea.event.pull_request.number }}"
          TOKEN="${{ secrets.GITEA_TOKEN }}"
          
          echo "Posting comment to: /repos/$OWNER/$REPO/issues/$PR_NUMBER/comments"
          
          curl -v -X POST "http://172.20.0.2:3000/api/v1/repos/$OWNER/$REPO/issues/$PR_NUMBER/comments" \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"body\": \"### ðŸ¤– Local AI Code Review\n\n$REVIEW_TEXT\"}" \
            --connect-timeout 10 \
            --max-time 30