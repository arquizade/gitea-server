networks:
  gitea:
    name: gitea_network  # EXPLICIT NAME ensures portability
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

services:
  gitea:
    image: gitea/gitea:latest 
    container_name: gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=sqlite3
    restart: always
    networks:
      gitea:
        ipv4_address: 172.20.0.2
    volumes:
      - ./data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "2222:22"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    networks:
      gitea:
        ipv4_address: 172.20.0.3
    volumes:
      - ./ollama:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4.0'
        reservations:
          memory: 4G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 3

  gitea-runner:
    image: gitea/act_runner:latest
    depends_on:
      gitea:
        condition: service_healthy
    container_name: gitea-runner
    restart: always
    networks:
      gitea:
        ipv4_address: 172.20.0.4
    volumes:
      - ./runner-data:/data
      - ./config.yaml:/config.yaml
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - GITEA_INSTANCE_URL=http://gitea:3000
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_REGISTRATION_TOKEN} 
      - GITEA_RUNNER_CONFIG=/config.yaml
      - DOCKER_BRIDGE_NETWORK=gitea_network
      - GIT_TERMINAL_PROMPT=0
      - GIT_SSL_NO_VERIFY=false
    extra_hosts:
      - "gitea:172.20.0.2"
      - "ollama:172.20.0.3"